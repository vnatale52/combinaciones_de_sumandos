<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Combinatoria de Sumandos</title>
  <style>
    body{font-family:"Segoe UI",Arial,sans-serif;background:#f8f9fa;color:#222;margin:0}
    .navbar{position:sticky;top:0;background:#2c2c2c;display:flex;justify-content:center;gap:15px;padding:6px 0;z-index:1000;box-shadow:0 2px 6px rgba(0,0,0,.25)}
    .navbar a{color:#f8f8f8;background:rgba(255,255,255,.08);text-decoration:none;padding:6px 14px;border-radius:8px;font-weight:bold;transition:.3s}
    .navbar a:hover{background:rgba(255,255,255,.25);transform:scale(1.05)}
    header{background:linear-gradient(270deg,#0078d7,#00a3ff,#0078d7);background-size:600% 600%;animation:gradientShift 8s ease infinite;color:white;text-align:center;padding:.8em 1em}
    header h1{font-size:1.6em;margin-bottom:.2em}header p{margin-top:0;font-size:.95em;opacity:.9}
    main{max-width:880px;margin:2em auto;background:white;padding:1.8em;border-radius:12px;box-shadow:0 3px 10px rgba(0,0,0,.15)}
    #output{background:#f4f4f4;border-radius:8px;padding:1em;margin-top:1em;white-space:pre-wrap;font-family:Consolas,monospace;color:#111}
    button{background:#0078d7;color:white;border:none;padding:10px 18px;border-radius:8px;cursor:pointer;font-weight:bold;transition:background .3s}
    button:hover{background:#005fa3}
    .download-animated{animation:glow 1.2s ease-in-out infinite alternate}
    @keyframes glow{0%{box-shadow:0 0 6px #0078d7}100%{box-shadow:0 0 18px #00a3ff}}
    footer{text-align:center;margin-top:40px;padding:1.1em;font-size:.9em;color:#555;background-color:#f1f1f1}
    @keyframes gradientShift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    .collapsible{background:#0078d7;color:white;cursor:pointer;padding:12px;width:100%;border:none;text-align:left;outline:none;font-size:1em;font-weight:bold;border-radius:8px;margin-bottom:10px;transition:background .3s}
    .collapsible:hover{background:#005fa3}
    .collapsible.active{background:#005fa3}
    .content{padding:0 18px;max-height:0;overflow:hidden;transition:max-height .3s ease-out;background-color:#f9f9f9;border-radius:8px}
    .content.show{max-height:2000px;padding:18px;margin-bottom:20px}
    .use-case{background:white;padding:12px;margin:10px 0;border-left:4px solid #0078d7;border-radius:4px}
    .use-case h4{margin-top:0;color:#0078d7}
    .example-section{background:#e8f4fd;padding:15px;border-radius:8px;margin:15px 0;text-align:center}
    .example-buttons{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:10px}
  </style>
</head>
<body>
  <nav class="navbar">
    <a href="combinaci√≥n_de_sumandos.py" download>‚¨áÔ∏è Descargar c√≥digo Python</a>
    <a href="README.md" download>üìò Descargar README</a>
    <a href="README.md" target="_blank">üëÅÔ∏è Ver README</a>
  </nav>

  <header>
    <h1>üî¢ Combinatoria de Sumandos</h1>
    <p>Basado en Google OR-Tools ‚Äî Ejecuci√≥n directa en el navegador con Pyodide</p>
    <p> This Web page is Under Construction and testing - By Vincenzo Natale </p>
  </header>

  <main>
    <button class="collapsible">üéØ Casos de Uso Pr√°cticos - ¬øPara qu√© sirve esta aplicaci√≥n?</button>
    <div class="content">
      <p><strong>Esta aplicaci√≥n es especialmente √∫til en contabilidad, auditor√≠a, administraci√≥n tributaria y financiera y cualquier contexto donde necesites descomponer un total en sus sumandos originales.</strong></p>
      
      <div class="use-case">
        <h4>üíº 1. Conciliaciones Contables</h4>
        <p><strong>Problema:</strong> Tienes un total general en el extracto bancario, pero necesitas identificar qu√© facturas o pagos espec√≠ficos lo componen.</p>
        <p><strong>Ejemplo:</strong> El banco muestra un dep√≥sito de $45.678,90 pero no sabes qu√© clientes pagaron. Cargas todas las facturas pendientes como sumandos, estableces $45.678,90 como objetivo, y el sistema identifica exactamente qu√© facturas fueron pagadas.</p>
      </div>

      <div class="use-case">
        <h4>üìä 2. Auditor√≠a y Control de Diferencias</h4>
        <p><strong>Problema:</strong> Existe una diferencia en la conciliaci√≥n que necesitas componer qu√© partidas individuales (sumandos, sea con signo positivo o signo negativo) integran dicha diferencia.</p>
        <p><strong>Ejemplo:</strong> Hay una diferencia de $1.234,56 entre dos reportes. Cargas todas las transacciones del per√≠odo y el sistema te muestra qu√© combinaci√≥n de movimientos explica esa diferencia exacta.</p>
      </div>

      <div class="use-case">
        <h4>üîç 3. Detecci√≥n de Errores de Carga M√∫ltiple</h4>
        <p><strong>Problema:</strong> Sospechas que una misma factura fue cargada dos o m√°s veces.</p>
        <p><strong>Ejemplo:</strong> El total de gastos da $8.500,00 pero deber√≠a ser $4.250,00. Cargas todos los gastos y buscas combinaciones que sumen exactamente la mitad, revelando duplicaciones.</p>
      </div>

      <div class="use-case">
        <h4>üí∞ 4. Reconciliaci√≥n de Pagos en Efectivo</h4>
        <p><strong>Problema:</strong> La caja registra un total pero necesitas saber qu√© billetes y monedas espec√≠ficos lo componen.</p>
        <p><strong>Ejemplo:</strong> Tienes $12.450,00 en caja. Cargas los valores de todos los billetes y monedas contados, y verificas si alguna combinaci√≥n suma exactamente ese total (o detectas faltantes/sobrantes).</p>
      </div>

      <div class="use-case">
        <h4>üè¶ 5. An√°lisis de Transferencias Agrupadas</h4>
        <p><strong>Problema:</strong> Recibiste una transferencia √∫nica que agrupa varios conceptos.</p>
        <p><strong>Ejemplo:</strong> Llega una transferencia de $23.789,45 que incluye varios pagos. Cargas todas las cuentas por cobrar y descubres qu√© clientes espec√≠ficos pagaron en ese lote.</p>
      </div>

      <div class="use-case">
        <h4>üì¶ 6. Control de Inventario y Valuaci√≥n</h4>
        <p><strong>Problema:</strong> Necesitas identificar qu√© items espec√≠ficos componen un valor total de inventario.</p>
        <p><strong>Ejemplo:</strong> Un pallet valorizado en $156.890,00 contiene m√∫ltiples productos. Cargas los valores unitarios de cada item y descubres la composici√≥n exacta del pallet.</p>
      </div>

      <div class="use-case">
        <h4>‚öñÔ∏è 7. Resoluci√≥n de Disputas Comerciales</h4>
        <p><strong>Problema:</strong> Un cliente afirma haber pagado cierto monto pero no tienes claro qu√© facturas espec√≠ficas cubri√≥.</p>
        <p><strong>Ejemplo:</strong> El cliente dice "pagu√© $67.543,21". Cargas todas sus facturas pendientes y el sistema muestra exactamente qu√© facturas quedaron cubiertas con ese pago.</p>
      </div>

      <div class="use-case">
        <h4>üßæ 8. An√°lisis de Gastos por Categor√≠a</h4>
        <p><strong>Problema:</strong> Tienes un total de gastos en una categor√≠a pero necesitas identificar las transacciones espec√≠ficas.</p>
        <p><strong>Ejemplo:</strong> Los gastos de "Servicios" totalizan $34.567,89. Cargas todos los recibos y verificas que la suma sea correcta, o detectas transacciones mal categorizadas.</p>
      </div>

      <div class="use-case">
        <h4>üí≥ 9. Conciliaci√≥n de Tarjetas de Cr√©dito Corporativas</h4>
        <p><strong>Problema:</strong> El resumen de la tarjeta muestra un total pero necesitas validar contra los comprobantes individuales.</p>
        <p><strong>Ejemplo:</strong> El resumen indica $89.234,67 en compras. Cargas todos los tickets y verificas que coincidan, o detectas cargos no autorizados.</p>
      </div>

      <div class="use-case">
        <h4>üî¢ 10. Optimizaci√≥n de Pagos con Fondos Limitados</h4>
        <p><strong>Problema:</strong> Tienes un monto disponible y necesitas decidir qu√© facturas pagar exactamente.</p>
        <p><strong>Ejemplo:</strong> Dispones de $100.000,00 y tienes 30 facturas pendientes. El sistema te muestra todas las combinaciones posibles de facturas que puedes pagar sin exceder ese monto.</p>
      </div>

      <p style="margin-top:20px;"><strong>üåü Ventajas Clave:</strong></p>
      <ul>
        <li>‚úÖ <strong>Precisi√≥n Total:</strong> Encuentra combinaciones exactas sin aproximaciones</li>
        <li>‚úÖ <strong>Exhaustividad:</strong> Muestra TODAS las combinaciones posibles</li>
        <li>‚úÖ <strong>Flexibilidad:</strong> Acepta margen de error o dispersi√≥n o tolerancia, para casos con redondeos de centavos o importes inmateriales o no signifcativos</li>
        <li>‚úÖ <strong>Formato Local:</strong> Dise√±ado espec√≠ficamente para n√∫meros en formato local utilizado en Argentina</li>
        <li>‚úÖ <strong>Sin Infraestructura:</strong> La versi√≥n Web funciona 100% en el navegador</li>
      </ul>
    </div>

    <div class="example-section">
      <h3>üì• Archivo de Ejemplo</h3>
      <p>Descarga un archivo de ejemplo completo con un caso pr√°ctico de conciliaci√≥n contable:</p>
      <div class="example-buttons">
        <button onclick="descargarEjemplo()">üìÑ Descargar sumandos_ejemplo.txt</button>
        <button onclick="descargarInstrucciones()">üìã Descargar instrucciones de uso</button>
      </div>
      <p style="margin-top:10px;font-size:0.9em;color:#555;">
        <strong>Caso pr√°ctico incluido:</strong> 20 facturas pendientes de cobro. Objetivo: encontrar cu√°les suman $15.242,20
      </p>
    </div>

    <h2>‚öôÔ∏è Ejecutar Combinaciones</h2>
    <p>Sube tu archivo <code>sumandos.txt</code> en formato argentino (coma decimal, sin puntos de miles), indica el valor objetivo y el margen de error o dispersi√≥n.</p>
    <input type="file" id="fileInput" accept=".txt" /><br><br>
    <label for="objetivo">Objetivo: </label>
    <input type="text" id="objetivo" placeholder="ej. 19,35" />  
    <label for="margen">Margen (ej. 0,02): </label>
    <input type="text" id="margen" placeholder="ej. 0,01" value="0,00" />
    <br><br>
    <button id="runButton">üîç Calcular combinaciones</button>

    <div id="output">Esperando datos...</div>
    <div id="downloadContainer" style="display:none; text-align:center; margin-top:20px;">
      <button id="downloadButton" class="download-animated">üíæ Descargar resultados</button>
    </div>
  </main>

  <footer>
    Despliegue en GitHub Pages ‚Äî Proyecto: Combinatoria de Sumandos con Pyodide<br>
    ¬© 2025 ‚Äî C√≥digo realizado por Vincenzo Natale ¬∑ vnatale52@gmail.com
  </footer>

  <script src="https://cdn.jsdelivr.net/pyodide/v0.26.2/full/pyodide.js"></script>
  <script>
    let pyodide, resultText = "", counterInterval;

    async function loadPyodideAndPackages() {
      pyodide = await loadPyodide();
      document.getElementById("output").textContent = "‚úÖ Pyodide cargado correctamente. Esperando archivo...";
    }
    loadPyodideAndPackages();

    function verificarFormatoCadena(cad) {
      // Control simple: no debe contener punto como separador de miles
      if (cad.indexOf('.') !== -1) {
        return { valido: false, mensaje: "Contiene punto (.) ‚Äî posible separador de miles." };
      }
      if (cad.indexOf(',') !== -1) {
        // tiene coma decimal, intentamos parsear
        const v = parseFloat(cad.replace(",", "."));
        return isNaN(v) ? { valido: false, mensaje: "No convertible con coma decimal." } : { valido: true, mensaje: "Formato correcto (coma decimal)." , valor:v};
      }
      // entero sin separadores ‚Äî v√°lido
      const v = parseFloat(cad);
      return isNaN(v) ? { valido: false, mensaje: "No es un n√∫mero v√°lido." } : { valido: true, mensaje: "Formato correcto (entero sin separadores)." , valor:v};
    }

    document.getElementById("runButton").addEventListener("click", async () => {
      const fileInput = document.getElementById("fileInput");
      const objetivoStr = document.getElementById("objetivo").value.trim();
      const margenStr = document.getElementById("margen").value.trim();
      const output = document.getElementById("output");
      const downloadContainer = document.getElementById("downloadContainer");

      downloadContainer.style.display = "none";

      if (!fileInput.files[0]) {
        output.textContent = "‚ö†Ô∏è Por favor selecciona un archivo sumandos.txt.";
        return;
      }

      const inicio = new Date();
      const startTime = performance.now();
      const text = await fileInput.files[0].text();
      const linesRaw = text.split(/[\r\n]+/).map(l => l.trim()).filter(l => l !== "");

      // Control de formato por l√≠nea
      let controlLines = [];
      let sumandos = [];
      for (const l of linesRaw) {
        const hasDot = l.indexOf('.') !== -1;
        const hasComma = l.indexOf(',') !== -1;
        if (hasDot) {
          // intento de conversi√≥n autom√°tica, pero registro la detecci√≥n
          let converted = parseFloat(l.replace(/\./g, '').replace(',', '.'));
          if (isNaN(converted)) {
            controlLines.push(`${l} -> ‚ùå Formato inv√°lido: contiene punto y no convertible.`);
            continue;
          } else {
            controlLines.push(`${l} -> ‚ùå Contiene punto (se asumi√≥ separador de miles). Conversi√≥n autom√°tica aplicada.`);
            sumandos.push(converted);
            continue;
          }
        }
        if (hasComma) {
          let converted = parseFloat(l.replace(',', '.'));
          if (isNaN(converted)) {
            controlLines.push(`${l} -> ‚ùå Contiene coma pero no convertible.`);
            continue;
          } else {
            controlLines.push(`${l} -> ‚úÖ Formato correcto (coma decimal).`);
            sumandos.push(converted);
            continue;
          }
        }
        // entero sin separadores
        let converted = parseFloat(l);
        if (isNaN(converted)) {
          controlLines.push(`${l} -> ‚ùå No convertible.`);
        } else {
          controlLines.push(`${l} -> ‚úÖ Formato correcto (entero sin separadores).`);
          sumandos.push(converted);
        }
      }

      // Verificaci√≥n objetivo y margen
      const objCheck = verificarFormatoCadena(objetivoStr);
      const margenCheck = verificarFormatoCadena(margenStr);

      // Parseo (permitimos conversi√≥n autom√°tica si hab√≠a puntos pero lo informamos)
      let objetivo = objCheck.valor !== undefined ? objCheck.valor : parseFloat(objetivoStr.replace(/\./g, '').replace(',', '.'));
      let margen = margenCheck.valor !== undefined ? margenCheck.valor : parseFloat(margenStr.replace(/\./g, '').replace(',', '.'));
      if (isNaN(objetivo) || isNaN(margen)) {
        output.textContent = "‚ùå Objetivo o margen no v√°lidos tras intento de conversi√≥n.";
        return;
      }

      // Ajuste de margen a positivo si hay negativo (se informa)
      if (margen < 0) margen = Math.abs(margen);

      const rangoMin = (objetivo - margen).toLocaleString("es-AR", {minimumFractionDigits:2});
      const rangoMax = (objetivo + margen).toLocaleString("es-AR", {minimumFractionDigits:2});
      const condicion = margen === 0 ? "suma_total == objetivo" : "objetivo - margen ‚â§ suma_total ‚â§ objetivo + margen";

      clearInterval(counterInterval);
      let count = 0;
      const statusDiv = document.createElement("div");
      statusDiv.style.marginTop = "8px";
      statusDiv.textContent = "üîÑ Buscando combinaciones...";
      output.innerHTML = "";
      output.appendChild(statusDiv);

      counterInterval = setInterval(() => {
        count++;
        statusDiv.textContent = `üîÑ Buscando combinaciones... ${count}`;
      }, 500);

      const code = `
from itertools import combinations
sumandos=${JSON.stringify(sumandos)}
objetivo=${objetivo}
margen=${margen}
soluciones=[]
for r in range(1,len(sumandos)+1):
  for combo in combinations(sumandos,r):
    if abs(sum(combo)-objetivo)<=margen:
      soluciones.append(combo)
output=""
if soluciones:
  for i,s in enumerate(soluciones,1):
    exacta = " [EXACTA]" if abs(sum(s)-objetivo)<1e-9 else ""
    if exacta:
      nota = "EXACTO"
    else:
      nota = "HALLADA APLICANDO MARGEN"
    output+=f"--- Soluci√≥n {i}{exacta} ---\\nCombinaci√≥n:\\n"+"\\n".join([f"  {x:.2f}" for x in s])+f"\\nSuma total: {sum(s):.2f} ({nota})\\n\\n"
else:
  output="‚ùå No se encontraron combinaciones dentro del margen especificado.\\n"
output`;
      const logs = await pyodide.runPythonAsync(code);
      clearInterval(counterInterval);

      const fin = new Date();
      const elapsed = ((performance.now() - startTime) / 1000).toFixed(3);
      const elapsedNum = parseFloat(elapsed);
      const horas = Math.floor(elapsedNum / 3600);
      const minutos = Math.floor((elapsedNum % 3600) / 60);
      const segundos = Math.floor(elapsedNum % 60);
      const tiempoFormateado = `${horas.toString().padStart(2, '0')}:${minutos.toString().padStart(2, '0')}:${segundos.toString().padStart(2, '0')}`;
      const numComb = (logs.match(/Soluci√≥n/g) || []).length;

      if (numComb > 0) {
        statusDiv.textContent = `‚úÖ Se encontraron ${numComb} combinaciones.`;
        statusDiv.style.color = "green";
      } else {
        statusDiv.textContent = `‚ùå No se encontraron combinaciones.`;
        statusDiv.style.color = "red";
      }

      // Texto duplicados
      const counts = {};
      linesRaw.forEach(v => { counts[v] = (counts[v] || 0) + 1; });
      const dup = Object.entries(counts).filter(([k, v]) => v > 1);
      let textoDuplicados = "";
      if (dup.length > 0) {
        textoDuplicados = "Atenci√≥n: Se detectaron valores duplicados en el archivo:\n";
        dup.forEach(([valor, veces]) => { textoDuplicados += `   - ${valor} aparece ${veces} veces\n`; });
        textoDuplicados += "   Estos duplicados pueden generar combinaciones equivalentes.\n";
      } else {
        textoDuplicados = "‚úÖ No se detectaron combinaciones equivalentes generadas por sumandos que est√©n repetidos.\n";
      }

      const fmt = n => n.toLocaleString("es-AR", {minimumFractionDigits:2});
      resultText = `
------------------------------------------------------------
üî¢ COMBINATORIA DE SUMANDOS ‚Äî Versi√≥n Web (Pyodide)
------------------------------------------------------------
<strong>Detalles del c√°lculo:</strong>
üïí Inicio: ${inicio.toLocaleString()}
üïï Fin: ${fin.toLocaleString()}
üéØ Objetivo: ${fmt(objetivo)}
üí∞ Margen de error o dispersi√≥n en m√°s o en menos: ¬±${fmt(margen)} pesos
üìà Rango v√°lido: desde ${rangoMin} hasta ${rangoMax}
‚öôÔ∏è Condici√≥n aplicada: ${condicion}
üïí Tiempo total: ${elapsed} segundos  |  ${tiempoFormateado} (hh:mm:ss)

üîé Control de formato del archivo de entrada (Argentina):
${controlLines.join("\n")}

üîé Control de formato - objetivo/margen:
Objetivo: ${objCheck.mensaje || ""}
Margen: ${margenCheck.mensaje || ""}

${textoDuplicados}

--- Sumandos cargados ---
${linesRaw.join("\n")}

--- Soluciones encontradas ---
${logs.replace(/\./g, ",")}

‚öôÔ∏è C√≥digo ejecutado mediante Pyodide (versi√≥n web)
C√≥digo original: combinador_sumandos.py
Autor: Vincenzo Natale ‚Äî vnatale52@gmail.com
¬© 2025 ‚Äî Todos los derechos reservados.
------------------------------------------------------------
`;
      output.textContent = resultText;
      downloadContainer.style.display = "block";
    });

    document.getElementById("downloadButton").addEventListener("click", () => {
      if (!resultText) { alert("‚ö†Ô∏è Primero ejecuta el c√°lculo antes de descargar los resultados."); return; }
      const blob = new Blob([resultText], { type: "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "soluciones_sumandos.txt";
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // Bot√≥n colapsable de casos de uso
    document.querySelector('.collapsible').addEventListener('click', function() {
      this.classList.toggle('active');
      const content = this.nextElementSibling;
      content.classList.toggle('show');
    });

    // Funci√≥n para descargar el archivo de ejemplo
    function descargarEjemplo() {
      const contenido = `1250,50
3400,00
890,75
2100,00
5600,30
1500,00
4200,90
750,25
3300,00
1800,45
2900,00
1100,80
6500,00
2300,50
1950,00
3800,00
1400,60
2700,00
4100,00
1600,25`;
      const blob = new Blob([contenido], { type: "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "sumandos_ejemplo.txt";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Funci√≥n para descargar las instrucciones
    function descargarInstrucciones() {
      const contenido = `üìã ARCHIVO DE EJEMPLO - CONCILIACI√ìN CONTABLE
=====================================================

Este archivo contiene 20 facturas pendientes de cobro.

üéØ CASO PR√ÅCTICO:
Recibiste una transferencia bancaria de $15.242,20 y necesitas 
identificar qu√© facturas espec√≠ficas fueron pagadas por el cliente.

üìä VALORES A USAR:
- Archivo: sumandos_ejemplo.txt (20 facturas)
- Objetivo: 15242,20
- Margen: 0,01

üí° RESULTADO ESPERADO:
El sistema encontrar√° todas las combinaciones de facturas que 
suman exactamente $15.242,20 (o muy cercano seg√∫n el margen).

‚úÖ FORMATO ARGENTINO:
- Use coma (,) como separador decimal
- NO use punto (.) como separador de miles
- Ejemplo correcto: 15242,20
- Ejemplo incorrecto: 15.242,20 o 15242.20

üîç INSTRUCCIONES:
1. Descargue el archivo sumandos_ejemplo.txt
2. C√°rguelo en la aplicaci√≥n
3. Ingrese objetivo: 15242,20
4. Ingrese margen: 0,01
5. Presione "Calcular combinaciones"

El sistema le mostrar√° qu√© facturas espec√≠ficas suman ese total.`;
      const blob = new Blob([contenido], { type: "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "ejemplo_instrucciones.txt";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>